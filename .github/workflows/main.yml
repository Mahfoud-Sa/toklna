name: Build APK (Manual)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.3.2)"
        required: true

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'
          cache: true

      - name: Verify Flutter environment
        run: |
          flutter --version
          flutter doctor

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Find and rename APK
        id: rename_apk
        shell: pwsh
        run: |
          # Find APK
          $apk = Get-ChildItem -Path "build" -Filter "*.apk" -Recurse | Select-Object -First 1
          if (-not $apk) {
            Write-Host "APK file not found"
            exit 1
          }

          # Branch name (always available)
          $branch = "${{ github.ref_name }}".Replace("/", "-")

          # Version from dispatcher
          $version = "v${{ github.event.inputs.version }}"

          # Rename APK
          $newName = "twaklina_${branch}_${version}.apk"
          $newPath = Join-Path $apk.DirectoryName $newName
          Rename-Item $apk.FullName $newPath -Force

          echo "APK_PATH=$newPath" >> $env:GITHUB_OUTPUT

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: twaklina-apk
          path: ${{ steps.rename_apk.outputs.APK_PATH }}
