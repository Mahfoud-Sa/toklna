name: Build APK (Manual)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.3.2)"
        required: true

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'
          cache: true

      - name: Verify Flutter environment
        run: |
          flutter --version
          flutter doctor

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Find and rename APK
        id: rename_apk
        shell: pwsh
        run: |
          $apk = Get-ChildItem -Path "build" -Filter "*.apk" -Recurse | Select-Object -First 1
          if (-not $apk) {
            Write-Host "APK file not found"
            exit 1
          }

          $branch = "${{ github.ref_name }}".Replace("/", "-")
          $version = "v${{ github.event.inputs.version }}"

          $newName = "twaklina_${branch}_${version}.apk"
          $newPath = Join-Path $apk.DirectoryName $newName
          Rename-Item $apk.FullName $newPath -Force

          echo "APK_PATH=$newPath" >> $env:GITHUB_OUTPUT
          echo "APK_NAME=$newName" >> $env:GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: "Release v${{ github.event.inputs.version }}"
          body: |
            ðŸš€ Flutter APK Release  
            - Branch: `${{ github.ref_name }}`
            - Version: `v${{ github.event.inputs.version }}`
          draft: false
          prerelease: false
          files: ${{ steps.rename_apk.outputs.APK_PATH }}
